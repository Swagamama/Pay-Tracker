import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, Coffee, DollarSign, Clock } from 'lucide-react';

export default function HourlyPayCalculator() {
  const [hourlyRate, setHourlyRate] = useState('');
  const [isWorking, setIsWorking] = useState(false);
  const [onBreak, setOnBreak] = useState(false);
  const [currentPay, setCurrentPay] = useState(0);
  const [workStartTime, setWorkStartTime] = useState(null);
  const [totalWorkedSeconds, setTotalWorkedSeconds] = useState(0);
  const [breakStartTime, setBreakStartTime] = useState(null);
  const [breakTimeLeft, setBreakTimeLeft] = useState(0);
  
  const intervalRef = useRef(null);
  const breakTimeoutRef = useRef(null);
  const breakIntervalRef = useRef(null);

  // Clear all timers on component unmount
  useEffect(() => {
    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current);
      if (breakTimeoutRef.current) clearTimeout(breakTimeoutRef.current);
      if (breakIntervalRef.current) clearInterval(breakIntervalRef.current);
    };
  }, []);

  // Main work timer
  useEffect(() => {
    if (isWorking && !onBreak && hourlyRate) {
      intervalRef.current = setInterval(() => {
        const now = Date.now();
        const currentSessionSeconds = Math.floor((now - workStartTime) / 1000);
        const totalSeconds = totalWorkedSeconds + currentSessionSeconds;
        const hours = totalSeconds / 3600;
        const pay = hours * parseFloat(hourlyRate);
        setCurrentPay(pay);
      }, 100); // Update every 100ms for smooth animation
    } else {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
    }

    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current);
    };
  }, [isWorking, onBreak, hourlyRate, workStartTime, totalWorkedSeconds]);

  const startWork = () => {
    if (!hourlyRate || parseFloat(hourlyRate) <= 0) {
      alert('Please enter a valid hourly rate');
      return;
    }
    setIsWorking(true);
    setWorkStartTime(Date.now());
  };

  const pauseWork = () => {
    if (isWorking && workStartTime) {
      const workedThisSession = Math.floor((Date.now() - workStartTime) / 1000);
      setTotalWorkedSeconds(prev => prev + workedThisSession);
    }
    setIsWorking(false);
    setWorkStartTime(null);
  };

  const resetWork = () => {
    setIsWorking(false);
    setOnBreak(false);
    setCurrentPay(0);
    setWorkStartTime(null);
    setTotalWorkedSeconds(0);
    setBreakStartTime(null);
    setBreakTimeLeft(0);
    
    if (intervalRef.current) clearInterval(intervalRef.current);
    if (breakTimeoutRef.current) clearTimeout(breakTimeoutRef.current);
    if (breakIntervalRef.current) clearInterval(breakIntervalRef.current);
  };

  const startBreak = () => {
    if (!isWorking) return;
    
    // Save current work progress
    const workedThisSession = Math.floor((Date.now() - workStartTime) / 1000);
    setTotalWorkedSeconds(prev => prev + workedThisSession);
    
    setOnBreak(true);
    setBreakTimeLeft(30 * 60); // 30 minutes in seconds
    setBreakStartTime(Date.now());

    // Break countdown timer
    breakIntervalRef.current = setInterval(() => {
      setBreakTimeLeft(prev => {
        if (prev <= 1) {
          clearInterval(breakIntervalRef.current);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    // Auto-resume after 30 minutes
    breakTimeoutRef.current = setTimeout(() => {
      setOnBreak(false);
      setWorkStartTime(Date.now());
      setBreakTimeLeft(0);
      if (breakIntervalRef.current) clearInterval(breakIntervalRef.current);
    }, 30 * 60 * 1000);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(amount);
  };

  const getTotalWorkedTime = () => {
    let total = totalWorkedSeconds;
    if (isWorking && workStartTime && !onBreak) {
      total += Math.floor((Date.now() - workStartTime) / 1000);
    }
    return total;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-md mx-auto">
        <div className="bg-white rounded-3xl shadow-2xl p-8 space-y-6">
          <div className="text-center">
            <DollarSign className="w-16 h-16 text-green-500 mx-auto mb-4" />
            <h1 className="text-3xl font-bold text-gray-800">Pay Tracker</h1>
            <p className="text-gray-600">Live hourly earnings calculator</p>
          </div>

          {!isWorking ? (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hourly Rate ($)
                </label>
                <input
                  type="number"
                  step="0.01"
                  value={hourlyRate}
                  onChange={(e) => setHourlyRate(e.target.value)}
                  placeholder="Enter your hourly rate"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-lg text-center"
                />
              </div>
              <button
                onClick={startWork}
                className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition-colors flex items-center justify-center gap-2"
              >
                <Play className="w-5 h-5" />
                Start Working
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              <div className="text-center">
                <div className="text-6xl font-bold text-green-600 mb-2">
                  {formatCurrency(currentPay)}
                </div>
                <div className="text-lg text-gray-600 flex items-center justify-center gap-2">
                  <Clock className="w-5 h-5" />
                  {formatTime(getTotalWorkedTime())} worked
                </div>
                <div className="text-sm text-gray-500 mt-1">
                  ${hourlyRate}/hour
                </div>
              </div>

              {onBreak && (
                <div className="bg-orange-50 border-2 border-orange-200 rounded-xl p-4 text-center">
                  <Coffee className="w-8 h-8 text-orange-500 mx-auto mb-2" />
                  <div className="text-lg font-semibold text-orange-700">
                    Break Time
                  </div>
                  <div className="text-2xl font-bold text-orange-600">
                    {formatTime(breakTimeLeft)}
                  </div>
                  <div className="text-sm text-orange-600 mt-1">
                    Auto-resume when break ends
                  </div>
                </div>
              )}

              <div className="grid grid-cols-2 gap-3">
                {!onBreak && (
                  <button
                    onClick={startBreak}
                    className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2"
                  >
                    <Coffee className="w-4 h-4" />
                    30min Break
                  </button>
                )}
                <button
                  onClick={pauseWork}
                  className={`bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2 ${onBreak ? 'col-span-2' : ''}`}
                >
                  <Pause className="w-4 h-4" />
                  {onBreak ? 'End Break & Pause' : 'Pause Work'}
                </button>
              </div>

              <button
                onClick={resetWork}
                className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl transition-colors"
              >
                Reset Session
              </button>
            </div>
          )}

          <div className="text-center text-xs text-gray-400 border-t pt-4">
            Pay updates every 0.1 seconds while working
          </div>
        </div>
      </div>
    </div>
  );
}
